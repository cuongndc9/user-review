<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê√°nh gi√° ·ª©ng d·ª•ng c√¥ng ngh·ªá Vi·ªát Nam</title>
    <meta name="description" content="Kh√°m ph√° ƒë√°nh gi√° ng∆∞·ªùi d√πng c√°c ·ª©ng d·ª•ng mobile ph·ªï bi·∫øn t·∫°i Vi·ªát Nam">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/9131/9131478.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .hero { text-align: center; padding: 48px 24px; color: white; }
        .hero h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 16px; }
        .hero p { font-size: 1.1rem; opacity: 0.9; max-width: 600px; margin: 0 auto; }
        .app-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px 0; }
        .app-card { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; }
        .app-card:hover { transform: translateY(-8px); box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .app-card-gradient { height: 6px; }
        .app-card-content { padding: 24px; }
        .app-card-header { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
        .app-logo { width: 56px; height: 56px; border-radius: 12px; object-fit: contain; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .app-info h3 { font-size: 1.25rem; font-weight: 600; color: #111827; }
        .app-info p { font-size: 0.875rem; color: #6b7280; }
        .app-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding-top: 16px; border-top: 1px solid #f3f4f6; }
        .stat-mini { text-align: center; }
        .stat-mini-value { font-size: 1.1rem; font-weight: 600; color: #1f2937; }
        .stat-mini-label { font-size: 0.7rem; color: #6b7280; text-transform: uppercase; }
        .all-reviews-btn { display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; max-width: 500px; margin: 32px auto; padding: 18px 36px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 16px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 10px 30px rgba(102,126,234,0.4); transition: all 0.3s ease; }
        .all-reviews-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 40px rgba(102,126,234,0.5); }
        .back-btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: white; border: none; border-radius: 12px; font-size: 0.95rem; font-weight: 500; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.2s ease; color: #374151; }
        .back-btn:hover { background: #f9fafb; transform: translateX(-4px); }
        .dashboard-header { display: flex; align-items: center; gap: 20px; padding: 28px; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .dashboard-logo { width: 72px; height: 72px; border-radius: 16px; object-fit: contain; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); margin-bottom: 24px; overflow: hidden; }
        .card-header { padding: 20px 24px; border-bottom: 1px solid #f3f4f6; font-size: 1.1rem; font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 24px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; }
        .stat-card { background: linear-gradient(135deg, #f9fafb 0%, white 100%); padding: 20px; border-radius: 16px; text-align: center; border: 1px solid #f3f4f6; }
        .stat-card-value { font-size: 1.75rem; font-weight: 700; margin-bottom: 4px; }
        .stat-card-label { font-size: 0.75rem; color: #6b7280; text-transform: uppercase; }
        .filter-section { background: white; padding: 24px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); margin-bottom: 24px; }
        .filter-title { font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .filter-row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
        .filter-input { flex: 1; min-width: 200px; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 0.95rem; transition: all 0.2s ease; background: white; }
        .filter-input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 4px rgba(99,102,241,0.1); }
        .filter-select { padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 0.95rem; background: white; cursor: pointer; min-width: 150px; }
        .filter-select:focus { outline: none; border-color: #6366f1; }
        .btn { padding: 12px 24px; border: none; border-radius: 12px; font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; box-shadow: 0 4px 12px rgba(99,102,241,0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99,102,241,0.4); }
        .btn-secondary { background: #f3f4f6; color: #374151; }
        .btn-secondary:hover { background: #e5e7eb; }
        .results-info { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: linear-gradient(135deg, #f9fafb 0%, white 100%); border-radius: 12px; margin-bottom: 20px; border: 1px solid #f3f4f6; }
        .review-item { background: white; border: 1px solid #e5e7eb; border-radius: 16px; padding: 20px; margin-bottom: 16px; transition: all 0.2s ease; }
        .review-item:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.08); border-color: #d1d5db; }
        .review-header { display: flex; flex-wrap: wrap; align-items: center; gap: 12px; margin-bottom: 12px; }
        .company-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; color: white; }
        .company-badge img { width: 18px; height: 18px; border-radius: 4px; }
        .rating-stars { color: #f59e0b; font-size: 1.1rem; letter-spacing: 2px; }
        .sentiment-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        .sentiment-positive { background: #dcfce7; color: #16a34a; }
        .sentiment-neutral { background: #f3f4f6; color: #6b7280; }
        .sentiment-negative { background: #fee2e2; color: #dc2626; }
        .platform-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; background: #f3f4f6; color: #4b5563; }
        .review-author { font-weight: 500; color: #374151; }
        .review-title { font-size: 1rem; font-weight: 600; color: #111827; margin: 8px 0; }
        .review-categories { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
        .category-tag { padding: 4px 10px; background: #f3f4f6; border-radius: 20px; font-size: 0.75rem; color: #4b5563; }
        .review-meta { display: flex; gap: 16px; font-size: 0.8rem; color: #9ca3af; margin: 8px 0; }
        .review-content { background: #f9fafb; padding: 16px; border-radius: 12px; color: #374151; line-height: 1.7; font-size: 0.95rem; margin-top: 12px; }
        .developer-reply { margin-top: 16px; padding: 16px; background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%); border-radius: 12px; border-left: 4px solid #3b82f6; }
        .developer-reply-header { font-weight: 600; color: #1f2937; font-size: 0.85rem; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .load-more-btn { display: block; width: 100%; max-width: 400px; margin: 24px auto; padding: 16px 32px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; border: none; border-radius: 14px; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 8px 25px rgba(99,102,241,0.3); transition: all 0.3s ease; }
        .load-more-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(99,102,241,0.4); }
        .global-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .global-stat-card { background: white; padding: 24px 20px; border-radius: 16px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.08); }
        .global-stat-value { font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .global-stat-label { font-size: 0.8rem; color: #6b7280; margin-top: 4px; }
        .chart-wrapper { padding: 20px; }
        .footer { text-align: center; padding: 32px; color: white; opacity: 0.9; }
        .footer a { color: white; text-decoration: none; font-weight: 500; }
        .footer a:hover { text-decoration: underline; }
        .loading { text-align: center; padding: 60px; color: white; }
        .loading-spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .hero h1 { font-size: 1.75rem; }
            .hero p { font-size: 0.95rem; }
            .app-grid { grid-template-columns: 1fr; }
            .dashboard-header { flex-direction: column; text-align: center; }
            .filter-row { flex-direction: column; }
            .filter-input, .filter-select { width: 100%; min-width: auto; }
            .results-info { flex-direction: column; gap: 8px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div class="footer">
        ¬© 2025 Nguy·ªÖn Duy C∆∞∆°ng - <a href="https://www.linkedin.com/in/cuong9/" target="_blank">LinkedIn</a>
    </div>
    <script>
        const DEFAULT_ICON = 'https://cdn-icons-png.flaticon.com/512/9131/9131478.png';
        const APPS = [
            { key: 'be', name: 'Be', color: '#FFD600', logo: 'https://imgmainsite.be.com.vn/2020/08/388c3d6a-logo-be.jpeg', json: 'be_reviews.json' },
            { key: 'grab', name: 'Grab', color: '#00B14F', logo: 'https://www.cdnlogo.com/logos/g/49/grab.svg', json: 'grab_reviews.json' },
            { key: 'zalopay', name: 'ZaloPay', color: '#1e90ff', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQTlp4qW2M8xPofmuZHwEfGi9mNMWUG0zs53A&s', json: 'zalopay_reviews.json' },
            { key: 'shopee', name: 'Shopee', color: '#ee4d2d', logo: 'https://freepnglogo.com/images/all_img/1727674497_shopee-logo-png.png', json: 'shopee_reviews.json' },
            { key: 'zalo', name: 'Zalo', color: '#0068FF', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Icon_of_Zalo.svg/1024px-Icon_of_Zalo.svg.png', json: 'zalo_reviews.json' },
            { key: 'momo', name: 'MoMo', color: '#A50064', logo: 'https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png', json: 'momo_reviews.json' },
            { key: 'xanhsm', name: 'Xanh SM', color: '#00B14F', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/22/Xanh_SM_logo.svg/2560px-Xanh_SM_logo.svg.png', json: 'xanhsm_reviews.json' },
            { key: 'lazada', name: 'Lazada', color: '#132968', logo: 'https://static.cdnlogo.com/logos/l/48/lazada-icon350x350.png', json: 'lazada_reviews.json' },
            { key: 'tiki', name: 'Tiki', color: '#1ba0e2', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSxXZz2KkwktUnS9FLo-mTm1uVouIGs4ukWqg&s', json: 'tiki_reviews.json' },
            { key: 'tiktok', name: 'TikTok', color: '#010101', logo: 'https://www.citypng.com/public/uploads/preview/tik-tok-logo-transparent-square-701751694793273qftyarldbx.png', json: 'tiktok_reviews.json' },
        ];
        let currentApp = null, currentReviews = [], filteredReviews = [], allReviewsData = {}, allReviewsCombined = [], isAllReviewsMode = false, charts = {};
        const cache = {}, REVIEWS_PER_PAGE = 100;
        let currentDisplayCount = REVIEWS_PER_PAGE, currentSortOrder = 'newest';

        function formatDate(d) { if (!d) return ''; try { return new Date(d).toLocaleDateString('vi-VN') + ' ' + new Date(d).toLocaleTimeString('vi-VN', {hour:'2-digit',minute:'2-digit'}); } catch { return d; } }
        function getCacheKey(k) { const t = new Date(); return `${k}_${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`; }
        function isCacheValid(e) { if (!e) return false; return new Date(e.timestamp).toDateString() === new Date().toDateString(); }
        function formatNumber(n) { if (n >= 1e6) return (n/1e6).toFixed(1)+'M'; if (n >= 1e3) return (n/1e3).toFixed(1)+'K'; return n.toLocaleString(); }
        function adjustColor(c, a) { const h = c.replace('#',''), n = parseInt(h,16), r = Math.min(255,Math.max(0,(n>>16)+a)), g = Math.min(255,Math.max(0,((n>>8)&0xFF)+a)), b = Math.min(255,Math.max(0,(n&0xFF)+a)); return `#${(1<<24|r<<16|g<<8|b).toString(16).slice(1)}`; }
        function escapeHTML(s) { return s ? String(s).replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&apos;','"':'&quot;'}[c])) : ''; }

        function renderHome() {
            currentApp = null; currentReviews = []; filteredReviews = []; isAllReviewsMode = false; destroyCharts();
            document.getElementById('root').innerHTML = `
                <div class="hero"><h1>üéØ ƒê√°nh gi√° ·ª©ng d·ª•ng Vi·ªát Nam</h1><p>Kh√°m ph√° c·∫£m nh·∫≠n th·ª±c t·∫ø t·ª´ h√†ng tri·ªáu ng∆∞·ªùi d√πng iOS & Android. D·ªØ li·ªáu minh b·∫°ch, c·∫≠p nh·∫≠t h√†ng ng√†y.</p></div>
                <div class="container">
                    <button class="all-reviews-btn" id="view-all-btn"><span>üîç</span> Xem t·∫•t c·∫£ ƒë√°nh gi√° t·ª´ m·ªçi ·ª©ng d·ª•ng</button>
                    <div class="app-grid" id="app-grid"></div>
                </div>`;
            document.getElementById('view-all-btn').onclick = loadAllReviews;
            loadAppCards();
        }

        async function loadAppCards() {
            const grid = document.getElementById('app-grid');
            for (const app of APPS) {
                const ck = getCacheKey(app.key); let data = null;
                if (cache[ck] && isCacheValid(cache[ck])) { data = cache[ck].data; }
                else { try { const r = await fetch(`./${app.json}`); if (r.ok) { data = await r.json(); cache[ck] = {data, timestamp: new Date()}; } } catch {} }
                const stats = data ? calculateQuickStats(data) : null;
                grid.innerHTML += renderAppCard(app, stats);
            }
            APPS.forEach(app => { const c = document.getElementById(`app-card-${app.key}`); if (c && !c.classList.contains('disabled')) c.onclick = () => loadAppDashboard(app); });
        }

        function calculateQuickStats(d) { const t = d.length, p = d.filter(r => r.rating >= 4).length, a = t > 0 ? (d.reduce((s,r) => s+(r.rating||0), 0)/t).toFixed(1) : '0.0', s = t > 0 ? Math.round((p/t)*100) : 0; return {total:t, avgRating:a, satisfaction:s}; }

        function renderAppCard(app, stats) {
            return `<div class="app-card ${!stats ? 'disabled opacity-50 cursor-not-allowed' : ''}" id="app-card-${app.key}">
                <div class="app-card-gradient" style="background:linear-gradient(135deg,${app.color} 0%,${adjustColor(app.color,-20)} 100%)"></div>
                <div class="app-card-content">
                    <div class="app-card-header">
                        <img src="${app.logo||DEFAULT_ICON}" alt="${app.name}" class="app-logo" onerror="this.src='${DEFAULT_ICON}'"/>
                        <div class="app-info"><h3>${app.name}</h3><p>${stats ? 'Xem ƒë√°nh gi√° chi ti·∫øt' : 'Ch∆∞a c√≥ d·ªØ li·ªáu'}</p></div>
                    </div>
                    ${stats ? `<div class="app-stats">
                        <div class="stat-mini"><div class="stat-mini-value">${formatNumber(stats.total)}</div><div class="stat-mini-label">ƒê√°nh gi√°</div></div>
                        <div class="stat-mini"><div class="stat-mini-value">${stats.avgRating}‚òÖ</div><div class="stat-mini-label">Trung b√¨nh</div></div>
                        <div class="stat-mini"><div class="stat-mini-value" style="color:#16a34a">${stats.satisfaction}%</div><div class="stat-mini-label">H√†i l√≤ng</div></div>
                    </div>` : ''}
                </div>
            </div>`;
        }

        async function loadAllReviews() {
            isAllReviewsMode = true; currentDisplayCount = REVIEWS_PER_PAGE; currentSortOrder = 'newest'; destroyCharts();
            document.getElementById('root').innerHTML = `<div class="container" style="padding-top:32px;"><button class="back-btn" id="back-btn">‚Üê Quay l·∫°i</button><div class="loading"><div class="loading-spinner"></div><p>ƒêang t·∫£i d·ªØ li·ªáu...</p></div></div>`;
            document.getElementById('back-btn').onclick = renderHome;
            const results = await Promise.all(APPS.map(async app => { const ck = getCacheKey(app.key); if (cache[ck] && isCacheValid(cache[ck])) return {app, data: cache[ck].data}; try { const r = await fetch(`./${app.json}`); if (!r.ok) return {app, data:[]}; const d = await r.json(); cache[ck] = {data:d, timestamp:new Date()}; return {app, data:d}; } catch { return {app, data:[]}; } }));
            allReviewsData = {}; allReviewsCombined = [];
            results.forEach(({app, data}) => { allReviewsData[app.key] = data; allReviewsCombined = allReviewsCombined.concat(data.map(r => ({...r, appKey:app.key, appName:app.name, appColor:app.color, appLogo:app.logo}))); });
            allReviewsCombined.sort((a,b) => new Date(b.date) - new Date(a.date));
            currentReviews = allReviewsCombined; filteredReviews = allReviewsCombined;
            renderAllReviewsDashboard();
        }

        function renderAllReviewsDashboard() {
            const total = allReviewsCombined.length, allCats = Array.from(new Set(allReviewsCombined.flatMap(r => r.categories||[]))), sat = total > 0 ? Math.round((allReviewsCombined.filter(r => r.rating >= 4).length/total)*100) : 0;
            document.getElementById('root').innerHTML = `
                <div class="container" style="padding-top:32px;">
                    <button class="back-btn" id="back-btn">‚Üê Quay l·∫°i</button>
                    <h1 style="color:white;margin:24px 0 8px;font-size:2rem;">üîç T·∫•t c·∫£ ƒë√°nh gi√°</h1>
                    <p style="color:rgba(255,255,255,0.8);margin-bottom:24px;">T√¨m ki·∫øm trong ${formatNumber(total)} ƒë√°nh gi√° t·ª´ ${APPS.length} ·ª©ng d·ª•ng</p>
                    <div class="global-stats">
                        <div class="global-stat-card"><div class="global-stat-value">${formatNumber(total)}</div><div class="global-stat-label">T·ªïng ƒë√°nh gi√°</div></div>
                        <div class="global-stat-card"><div class="global-stat-value">${APPS.length}</div><div class="global-stat-label">·ª®ng d·ª•ng</div></div>
                        <div class="global-stat-card"><div class="global-stat-value">${allCats.length}</div><div class="global-stat-label">Danh m·ª•c</div></div>
                        <div class="global-stat-card"><div class="global-stat-value">${sat}%</div><div class="global-stat-label">H√†i l√≤ng</div></div>
                    </div>
                    <div class="filter-section">
                        <div class="filter-title">üîé T√¨m ki·∫øm & L·ªçc</div>
                        <div class="filter-row">
                            <input type="text" id="global-search" class="filter-input" placeholder="T√¨m ki·∫øm n·ªôi dung..."/>
                            <select id="global-company" class="filter-select"><option value="">T·∫•t c·∫£ c√¥ng ty</option>${APPS.map(a => `<option value="${a.key}">${a.name}</option>`).join('')}</select>
                            <select id="global-category" class="filter-select"><option value="">T·∫•t c·∫£ danh m·ª•c</option>${allCats.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
                        </div>
                        <div class="filter-row" style="margin-top:12px;">
                            <select id="global-platform" class="filter-select"><option value="">T·∫•t c·∫£ thi·∫øt b·ªã</option><option value="android">Android</option><option value="ios">iOS</option></select>
                            <select id="global-rating" class="filter-select"><option value="">T·∫•t c·∫£ sao</option>${[5,4,3,2,1].map(r => `<option value="${r}">${r} ‚òÖ</option>`).join('')}</select>
                            <select id="global-sentiment" class="filter-select"><option value="">T·∫•t c·∫£ c·∫£m x√∫c</option><option value="positive">T√≠ch c·ª±c</option><option value="neutral">Trung l·∫≠p</option><option value="negative">Ti√™u c·ª±c</option></select>
                            <select id="global-sort" class="filter-select"><option value="newest">M·ªõi nh·∫•t</option><option value="oldest">C≈© nh·∫•t</option><option value="highest">Sao cao</option><option value="lowest">Sao th·∫•p</option></select>
                        </div>
                        <div style="margin-top:16px;display:flex;gap:12px;">
                            <button class="btn btn-primary" id="global-filter-btn">üîç T√¨m ki·∫øm</button>
                            <button class="btn btn-secondary" id="global-reset-btn">‚Ü∫ ƒê·∫∑t l·∫°i</button>
                        </div>
                    </div>
                    <div class="card"><div class="card-header">üìù Danh s√°ch ƒë√°nh gi√°</div><div class="card-body"><div id="review-list"></div></div></div>
                </div>`;
            document.getElementById('back-btn').onclick = renderHome;
            document.getElementById('global-filter-btn').onclick = applyGlobalFilters;
            document.getElementById('global-reset-btn').onclick = resetGlobalFilters;
            document.getElementById('global-search').onkeyup = e => { if (e.key === 'Enter') applyGlobalFilters(); };
            document.getElementById('global-sort').onchange = () => { currentSortOrder = document.getElementById('global-sort').value; sortAndRender(); };
            renderReviewList(filteredReviews);
        }

        function applyGlobalFilters() {
            const s = document.getElementById('global-search').value.trim().toLowerCase(), co = document.getElementById('global-company').value, ca = document.getElementById('global-category').value, pl = document.getElementById('global-platform').value, ra = document.getElementById('global-rating').value, se = document.getElementById('global-sentiment').value;
            filteredReviews = allReviewsCombined.filter(r => { if (s && !((r.text||'').toLowerCase().includes(s) || (r.title||'').toLowerCase().includes(s))) return false; if (co && r.appKey !== co) return false; if (ca && !(r.categories||[]).includes(ca)) return false; if (pl && r.platform !== pl) return false; if (ra && String(r.rating) !== ra) return false; if (se && (!r.sentiment || r.sentiment.label !== se)) return false; return true; });
            currentDisplayCount = REVIEWS_PER_PAGE; sortAndRender();
        }

        function resetGlobalFilters() { ['global-search','global-company','global-category','global-platform','global-rating','global-sentiment'].forEach(id => document.getElementById(id).value = ''); document.getElementById('global-sort').value = 'newest'; filteredReviews = allReviewsCombined; currentDisplayCount = REVIEWS_PER_PAGE; currentSortOrder = 'newest'; sortAndRender(); }

        function sortAndRender() { const s = [...filteredReviews]; switch(currentSortOrder) { case 'newest': s.sort((a,b) => new Date(b.date) - new Date(a.date)); break; case 'oldest': s.sort((a,b) => new Date(a.date) - new Date(b.date)); break; case 'highest': s.sort((a,b) => (b.rating||0) - (a.rating||0)); break; case 'lowest': s.sort((a,b) => (a.rating||0) - (b.rating||0)); break; } filteredReviews = s; renderReviewList(filteredReviews); }

        function renderReviewList(reviews) {
            const c = document.getElementById('review-list'); if (!c) return;
            if (!reviews.length) { c.innerHTML = '<div style="text-align:center;color:#6b7280;padding:40px;">Kh√¥ng t√¨m th·∫•y ƒë√°nh gi√°.</div>'; return; }
            const disp = reviews.slice(0, currentDisplayCount), rem = reviews.length - currentDisplayCount;
            let h = `<div class="results-info"><span>Hi·ªÉn th·ªã <strong>${disp.length.toLocaleString()}</strong> / <strong>${reviews.length.toLocaleString()}</strong></span></div>`;
            h += disp.map(renderReviewItem).join('');
            if (rem > 0) h += `<button class="load-more-btn" id="load-more">üìÑ Xem th√™m ${Math.min(rem, REVIEWS_PER_PAGE).toLocaleString()} (c√≤n ${rem.toLocaleString()})</button>`;
            c.innerHTML = h;
            const btn = document.getElementById('load-more'); if (btn) btn.onclick = () => { currentDisplayCount += REVIEWS_PER_PAGE; renderReviewList(filteredReviews); };
        }

        function renderReviewItem(r) {
            const sl = r.sentiment?.label || 'neutral', sls = {positive:'T√≠ch c·ª±c',neutral:'Trung l·∫≠p',negative:'Ti√™u c·ª±c'};
            return `<div class="review-item" style="border-left:4px solid ${r.appColor||'#d1d5db'};">
                <div class="review-header">
                    ${r.appName ? `<span class="company-badge" style="background:${r.appColor||'#666'};"><img src="${r.appLogo||DEFAULT_ICON}" onerror="this.src='${DEFAULT_ICON}'"/> ${r.appName}</span>` : ''}
                    <span class="rating-stars">${'‚òÖ'.repeat(r.rating||0)}${'‚òÜ'.repeat(5-(r.rating||0))}</span>
                    <span class="sentiment-badge sentiment-${sl}">${sls[sl]}</span>
                    <span class="platform-badge">${r.platform||'N/A'}</span>
                </div>
                <div class="review-author">üë§ ${r.author||'·∫®n danh'}</div>
                ${r.title ? `<div class="review-title">üìå ${escapeHTML(r.title)}</div>` : ''}
                <div class="review-categories">${(r.categories||[]).map(c => `<span class="category-tag">${c}</span>`).join('')}</div>
                <div class="review-meta"><span>üìÖ ${formatDate(r.date)}</span>${r.version ? `<span>üì± v${r.version}</span>` : ''}</div>
                <div class="review-content">${r.text ? escapeHTML(r.text) : '<em style="color:#9ca3af;">Kh√¥ng c√≥ n·ªôi dung</em>'}</div>
                ${r.replyText ? `<div class="developer-reply"><div class="developer-reply-header">üí¨ Ph·∫£n h·ªìi t·ª´ nh√† ph√°t tri·ªÉn</div><div style="color:#4b5563;font-size:0.9rem;">${escapeHTML(r.replyText)}</div>${r.replyDate ? `<div style="color:#9ca3af;font-size:0.75rem;margin-top:8px;">${formatDate(r.replyDate)}</div>` : ''}</div>` : ''}
            </div>`;
        }

        function loadAppDashboard(app) {
            currentApp = app; currentDisplayCount = REVIEWS_PER_PAGE; isAllReviewsMode = false; destroyCharts();
            document.getElementById('root').innerHTML = `<div class="container" style="padding-top:32px;"><button class="back-btn" id="back-btn">‚Üê Quay l·∫°i</button><div class="loading"><div class="loading-spinner"></div><p>ƒêang t·∫£i...</p></div></div>`;
            document.getElementById('back-btn').onclick = renderHome;
            const ck = getCacheKey(app.key);
            if (cache[ck] && isCacheValid(cache[ck])) { currentReviews = cache[ck].data; filteredReviews = cache[ck].data; renderDashboard(app, cache[ck].data); return; }
            fetch(`./${app.json}`).then(r => r.ok ? r.json() : Promise.reject()).then(d => { cache[ck] = {data:d, timestamp:new Date()}; currentReviews = d; filteredReviews = d; renderDashboard(app, d); }).catch(() => { document.querySelector('.loading').innerHTML = '<div style="color:white;">Kh√¥ng c√≥ d·ªØ li·ªáu.</div>'; });
        }

        function renderDashboard(app, reviews) {
            const m = calculateMetrics(reviews);
            document.getElementById('root').innerHTML = `
                <div class="container" style="padding-top:32px;">
                    <button class="back-btn" id="back-btn">‚Üê Quay l·∫°i</button>
                    <div class="dashboard-header">
                        <img src="${app.logo||DEFAULT_ICON}" class="dashboard-logo" onerror="this.src='${DEFAULT_ICON}'"/>
                        <div><h2 style="color:${app.color};font-size:1.5rem;font-weight:700;">${app.name}</h2><p style="color:#6b7280;">Ph√¢n t√≠ch ƒë√°nh gi√° ng∆∞·ªùi d√πng</p></div>
                    </div>
                    <div class="card"><div class="card-header">üìä Th·ªëng k√™</div><div class="card-body"><div class="stats-grid">
                        <div class="stat-card"><div class="stat-card-value" style="color:${app.color}">${formatNumber(m.totalReviews)}</div><div class="stat-card-label">T·ªïng ƒë√°nh gi√°</div></div>
                        <div class="stat-card"><div class="stat-card-value" style="color:#16a34a">${m.satisfactionRate}%</div><div class="stat-card-label">H√†i l√≤ng</div></div>
                        <div class="stat-card"><div class="stat-card-value" style="color:#eab308">${m.averageRating}‚òÖ</div><div class="stat-card-label">ƒêi·ªÉm TB</div></div>
                        <div class="stat-card"><div class="stat-card-value" style="color:#ef4444">${m.negativeReviewRate}%</div><div class="stat-card-label">Ti√™u c·ª±c</div></div>
                    </div></div></div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px;">
                        <div class="card"><div class="card-header">‚≠ê Ph√¢n b·ªë</div><div class="card-body"><div class="chart-wrapper"><canvas id="ratingChart"></canvas></div></div></div>
                        <div class="card"><div class="card-header">üì± Thi·∫øt b·ªã</div><div class="card-body"><div class="chart-wrapper"><canvas id="deviceChart"></canvas></div></div></div>
                    </div>
                    <div class="card"><div class="card-header">üìÇ Danh m·ª•c</div><div class="card-body"><div class="chart-wrapper"><canvas id="categoryChart"></canvas></div></div></div>
                    <div class="filter-section">
                        <div class="filter-title">üîé L·ªçc</div>
                        <div class="filter-row">
                            <input type="text" id="search-input" class="filter-input" placeholder="T√¨m ki·∫øm..."/>
                            <select id="category-select" class="filter-select"><option value="">T·∫•t c·∫£ danh m·ª•c</option>${Object.keys(m.categoryCount).map(c => `<option value="${c}">${c}</option>`).join('')}</select>
                            <select id="device-select" class="filter-select"><option value="">T·∫•t c·∫£ thi·∫øt b·ªã</option>${Object.keys(m.deviceCount).map(d => `<option value="${d}">${d}</option>`).join('')}</select>
                            <select id="rating-select" class="filter-select"><option value="">T·∫•t c·∫£ sao</option>${[5,4,3,2,1].map(r => `<option value="${r}">${r} ‚òÖ</option>`).join('')}</select>
                        </div>
                        <div style="margin-top:12px;display:flex;gap:12px;"><button class="btn btn-primary" id="filter-btn">üîç L·ªçc</button><button class="btn btn-secondary" id="reset-btn">‚Ü∫ ƒê·∫∑t l·∫°i</button></div>
                    </div>
                    <div class="card"><div class="card-header">üìù ƒê√°nh gi√°</div><div class="card-body"><div id="review-list"></div></div></div>
                </div>`;
            document.getElementById('back-btn').onclick = renderHome;
            document.getElementById('filter-btn').onclick = applyFilters;
            document.getElementById('reset-btn').onclick = () => { ['search-input','category-select','device-select','rating-select'].forEach(id => document.getElementById(id).value = ''); filteredReviews = currentReviews; currentDisplayCount = REVIEWS_PER_PAGE; renderReviewList(filteredReviews); };
            renderCharts(m, app.color);
            filteredReviews = filteredReviews.map(r => ({...r, appName: app.name, appColor: app.color, appLogo: app.logo}));
            renderReviewList(filteredReviews);
        }

        function applyFilters() {
            const s = document.getElementById('search-input').value.trim().toLowerCase(), ca = document.getElementById('category-select').value, de = document.getElementById('device-select').value, ra = document.getElementById('rating-select').value;
            filteredReviews = currentReviews.filter(r => { if (s && !((r.text||'').toLowerCase().includes(s) || (r.title||'').toLowerCase().includes(s))) return false; if (ca && !(r.categories||[]).includes(ca)) return false; if (de && r.platform !== de) return false; if (ra && String(r.rating) !== ra) return false; return true; }).map(r => ({...r, appName: currentApp.name, appColor: currentApp.color, appLogo: currentApp.logo}));
            currentDisplayCount = REVIEWS_PER_PAGE; renderReviewList(filteredReviews);
        }

        function renderCharts(m, color) {
            charts.ratingChart = new Chart(document.getElementById('ratingChart').getContext('2d'), { type: 'bar', data: { labels: Object.keys(m.ratingsCount), datasets: [{data: Object.values(m.ratingsCount), backgroundColor: color+'80', borderColor: color, borderWidth: 2}] }, options: { responsive: true, plugins: {legend:{display:false}}, scales: {y:{beginAtZero:true}} } });
            charts.deviceChart = new Chart(document.getElementById('deviceChart').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(m.deviceCount), datasets: [{data: Object.values(m.deviceCount), backgroundColor: ['#6366f1','#22d3ee','#f472b6']}] }, options: { responsive: true, plugins: {legend:{position:'bottom'}} } });
            charts.categoryChart = new Chart(document.getElementById('categoryChart').getContext('2d'), { type: 'bar', data: { labels: Object.keys(m.categoryCount), datasets: [{data: Object.values(m.categoryCount), backgroundColor: color+'80', borderColor: color, borderWidth: 2}] }, options: { responsive: true, plugins: {legend:{display:false}}, scales: {y:{beginAtZero:true}} } });
        }

        function destroyCharts() { Object.values(charts).forEach(c => { try { c.destroy(); } catch {} }); charts = {}; }

        function calculateMetrics(d) {
            const rc = {1:0,2:0,3:0,4:0,5:0}, cc = {}, dc = {}; let p = 0, tr = 0, n = 0;
            d.forEach(r => { if (r.rating) { rc[r.rating]++; tr += r.rating; if (r.rating <= 2) n++; if (r.rating >= 4) p++; } if (r.platform) dc[r.platform] = (dc[r.platform]||0)+1; (r.categories||[]).forEach(c => cc[c] = (cc[c]||0)+1); });
            return { ratingsCount: rc, categoryCount: cc, deviceCount: dc, totalReviews: d.length, satisfactionRate: d.length ? ((p/d.length)*100).toFixed(1) : 0, averageRating: d.length ? (tr/d.length).toFixed(1) : '0.0', negativeReviewRate: d.length ? ((n/d.length)*100).toFixed(1) : 0 };
        }

        document.addEventListener('DOMContentLoaded', renderHome);
    </script>
</body>
</html>
